name: å®šæ—¶ä»»åŠ¡ - è‡ªåŠ¨å–æ¶ˆè¶…æ—¶è®¢å•

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '*/5 * * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æµ‹è¯•å®šæ—¶ä»»åŠ¡'

# è®¾ç½®æ—¶åŒº
env:
  TZ: 'Asia/Shanghai'

jobs:
  cancel-expired-orders:
    name: å–æ¶ˆè¶…æ—¶è®¢å•
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ æ˜¾ç¤ºæ‰§è¡Œä¿¡æ¯
        run: |
          echo "ğŸ• æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ”§ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ“ è§¦å‘åŸå› : ${{ github.event.inputs.reason }}"
          fi
          echo "ğŸŒ Supabase URL: ${{ secrets.SUPABASE_URL }}"
          echo "ğŸ”‘ Anon Key å·²é…ç½®: ${{ secrets.SUPABASE_ANON_KEY != '' }}"
      
      - name: ğŸš€ è°ƒç”¨ Edge Function - å–æ¶ˆè¶…æ—¶è®¢å•
        id: cancel_orders
        run: |
          echo "æ­£åœ¨è°ƒç”¨ Edge Function..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/cancel-expired-orders" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP çŠ¶æ€ç : $http_code"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… è®¢å•å–æ¶ˆä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
            # ä¿å­˜å“åº”åˆ°æ–‡ä»¶ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
            echo "$body" > /tmp/response.json
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ è®¢å•å–æ¶ˆä»»åŠ¡æ‰§è¡Œå¤±è´¥"
            echo "å“åº”å†…å®¹: $body"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ğŸ“Š è§£ææ‰§è¡Œç»“æœ
        if: steps.cancel_orders.outputs.success == 'true'
        run: |
          echo "æ‰§è¡Œç»“æœè¯¦æƒ…:"
          
          # ä»æ–‡ä»¶è¯»å–å¹¶æ ¼å¼åŒ– JSON
          if [ -f /tmp/response.json ]; then
            cat /tmp/response.json | jq '.' || echo "JSON è§£æå¤±è´¥ï¼ŒåŸå§‹å†…å®¹: $(cat /tmp/response.json)"
            
            # æå–å…³é”®ä¿¡æ¯ï¼ˆä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ï¼‰
            canceled_count=$(cat /tmp/response.json | jq -r '.canceledCount // 0' 2>/dev/null || echo "0")
            message=$(cat /tmp/response.json | jq -r '.message // "æ— æ¶ˆæ¯"' 2>/dev/null || echo "æ— æ¶ˆæ¯")
            
            echo ""
            echo "ğŸ“Š æ‰§è¡Œæ‘˜è¦:"
            echo "ğŸ“¦ æœ¬æ¬¡å–æ¶ˆè®¢å•æ•°: $canceled_count"
            echo "ğŸ’¬ æ‰§è¡Œæ¶ˆæ¯: $message"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å“åº”æ–‡ä»¶"
          fi
      
      - name: âš ï¸ å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥ï¼š"
          echo "1. Supabase URL æ˜¯å¦æ­£ç¡®"
          echo "2. Anon Key æ˜¯å¦æœ‰æ•ˆ"
          echo "3. Edge Function æ˜¯å¦å·²éƒ¨ç½²"
          echo "4. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"

  # å¥åº·æ£€æŸ¥ä»»åŠ¡ï¼ˆæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
  health-check:
    name: ç³»ç»Ÿå¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: ğŸ¥ æ£€æŸ¥ Supabase æœåŠ¡çŠ¶æ€
        run: |
          echo "æ£€æŸ¥ Supabase æœåŠ¡..."
          
          response=$(curl -s -w "\n%{http_code}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}")
          
          http_code=$(echo "$response" | tail -n1)
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 404 ]; then
            echo "âœ… Supabase æœåŠ¡æ­£å¸¸"
          else
            echo "âš ï¸ Supabase æœåŠ¡å¯èƒ½å­˜åœ¨é—®é¢˜ (HTTP $http_code)"
          fi
      
      - name: ğŸ“ˆ æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        run: |
          echo "=== ç³»ç»Ÿè¿è¡Œç»Ÿè®¡ ==="
          echo "ğŸ“… æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”„ å·¥ä½œæµè¿è¡Œæ¬¡æ•°: ${{ github.run_number }}"
          echo "ğŸ·ï¸ å·¥ä½œæµ ID: ${{ github.run_id }}"
